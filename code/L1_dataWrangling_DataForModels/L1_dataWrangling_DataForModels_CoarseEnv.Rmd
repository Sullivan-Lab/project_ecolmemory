---
title: "L2_dataAnalysis_CDCRdata_Nutrient - Data for Models"
author: "la√≠s petri"
date: "2024-01-31"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r package and directory, echo=FALSE}
## data wrangling + plots
library(tidyverse) 
library(scales)
```

Paths to import files, and export outputs
```{r}
rm(list = ls())

workingdir <- getwd()
datain <- file.path(workingdir, "data/L0")
dataout <- file.path(workingdir, "data/L1/DataModel_CoarseEnv")
```

Importing datasets
```{r}
# CDCR biomass data - species level
df2test <- read_csv(file.path(datain,"da_full_010924.csv"))
glimpse(df2test)

# Monthly weather data
df3test <- read_csv(file.path(datain,"da_weather_020625.csv"))
glimpse(df3test)
```

- Biomass data
```{r}
## aggregates plot level data
df2test <- df2test %>% 
  filter(live==1, #removes pine needles and litter
         # wood==0, #outliers in the biomass are due to trees, think better about them. Are some treatments more likely to have trees than others?
         year <2005) %>% 
  mutate(ntrt=as.factor(ntrt)) %>% 
  group_by(field,year, plot, exp, ntrt) %>% 
  summarise(plot_sum = sum(mass.above),
            richness = n()) %>% 
  ungroup()
```

# Disturbance
Wrangling data to match Drew's code

Given a type of disturbance, create plot and year indices, also check for missing years in the chronosequence
```{r}
expName <- "Dist_CoarseEnv" #exp==2, this object will be used later on to save files accordingly

# filter disturbance treatment
df2testNew <- df2test %>% 
  filter(exp==2) #2 = disturbance

# finds whether there are missing years within a chronology
# let's start by the plots that have data until 1991 (1992 on wards there were burning)
df2testNew1991 <- df2testNew %>% 
  unite(col='code', c('field','plot', 'exp', 'ntrt'), sep='_') %>% 
  group_by(code) %>% 
  summarise(minYear = min(year),
            maxYear = max(year)) %>% 
  ungroup() %>%
  filter(maxYear==1991) 

df2testNew2 <- df2testNew %>% 
  unite(col='code', c('field','plot', 'exp', 'ntrt'), sep='_',remove = F) %>% 
  filter(code %in% df2testNew1991$code) %>% 
  group_by(field,plot, exp, ntrt) %>% 
  mutate(plot_new2 = cur_group_id())

df_total1991 <- data.frame()

for(i in 1:max(df2testNew2$plot_new2)){
  df<-df2testNew2 %>% 
    filter(plot_new2==i)
  
  missing_years <- setdiff(1982:1991, df$year)
  
  df <- df %>% 
    select(field, plot, exp,ntrt) %>% 
    distinct() %>% 
    cbind(missing_years)
    # add vector to a dataframe
    df2 <- data.frame(df)
    df_total1991 <- rbind(df_total1991,df2)
    
}

df_total1991 # so output is empty! No missing year for these plots. 

# Let's check the ones that have data until 2004
df2testNew2004 <- df2testNew %>% 
  unite(col='code', c('field','plot', 'exp', 'ntrt'), sep='_') %>% 
  group_by(code) %>% 
  summarise(minYear = min(year),
            maxYear = max(year)) %>% 
  ungroup() %>%
  filter(maxYear!=1991) 

df2testNew2 <- df2testNew %>% 
  unite(col='code', c('field','plot', 'exp', 'ntrt'), sep='_', remove=F) %>% 
  filter(code %in% df2testNew2004$code) %>% 
  group_by(field,plot, exp, ntrt) %>% 
  mutate(plot_new2 = cur_group_id())

df_total2004 <- data.frame()

for(i in 1:max(df2testNew2$plot_new2)){
  df<-df2testNew2 %>% 
    filter(plot_new2==i)
  
  missing_years <- setdiff(1982:2004, df$year)
  
  df <- df %>% 
    select(field, plot, exp,ntrt) %>% 
    distinct() %>% 
    cbind(missing_years)
    # add vector to a dataframe
    df2 <- data.frame(df)
    df_total2004 <- rbind(df_total2004,df2)
}

df_total2004 <- df_total2004 %>% 
  rename(year=5)

head(df_total2004) # so there are several missing years!

df2testNew <- df2testNew %>% 
  bind_rows(df_total2004) %>% 
  arrange(ntrt,year,plot, exp,field) %>% #adding this line here and rerunning the models in case the order is defining things
  group_by(ntrt,field,plot,exp) %>%
  mutate(plot_new = cur_group_id()) %>% 
  ungroup() %>% 
  arrange(year) %>% 
  group_by(year) %>% 
  mutate(year_new = cur_group_id()) %>% 
  ungroup() %>% 
  arrange(plot_new)

#adding AR column
ARyearID <- df2testNew %>% 
  select(field,year_new,plot_sum,exp,ntrt,plot) %>% 
  mutate(year_new=year_new+1) %>% 
  rename(ARplot_sum=plot_sum)

df2testNew <- df2testNew %>% 
  left_join(ARyearID,by = join_by(field,plot, exp, ntrt, year_new))  %>% 
  mutate(ARplot_sum=ifelse(year==1982,0,ARplot_sum)) #adding zero cover as the first because in this particular case, disturbance happened and the field was tilled. my assumption is that no vegetation survived.

#which columns have NAs now?
df2testNew %>% map(~any(is.na(.x))) #plot_sum, richness, ARplot_sum. I need to account for this in the model!

#maximum length of plots with data
df2testNew %>% 
  select(plot_new, year_new) %>% 
  distinct() %>% 
  group_by(plot_new) %>% 
  count() %>% 
  ungroup() %>% 
  arrange(desc(n)) %>% 
  select(n) %>% 
  group_by(n) %>%
  count() %>% 
  ungroup()

maxLength <- df2testNew %>% 
  select(plot_new, year_new) %>% 
  distinct() %>% 
  group_by(plot_new) %>% 
  count() %>% 
  ungroup() %>% 
  arrange(desc(n)) %>% 
  select(n) %>% 
  group_by(n) %>%
  count() %>% 
  ungroup() %>% 
  filter(n==max(n)) %>%  as.numeric()

# Maximum number of plots
max(df2testNew$plot_new)

#disturbance index
df2testNewNtrt <- df2testNew %>% 
  select(plot_new,ntrt) %>% 
  distinct()
glimpse(df2testNewNtrt)

#range of years with plant data
range(df2testNew$year) #1982 to 2004, 1982-5 = 1977, so weather data should be from 1977 to 2004
yearRange<-range(df2testNew$year)
```

- Weather data
```{r}
#filtering the years of interest
df3testNew <- df3test %>% 
  filter(Year > yearRange[1]-3,
         Year < yearRange[2]+1)
range(df3testNew$Year) #correct!

#number of plots
max(df2testNew$plot_new)

# wrangling data for PRECIPTATION variable
df3testNewPrecip <- df3testNew %>% 
  select(Year,Month,Precip_mm) %>% 
  mutate(ID=1) 

# checking whether the data is complete
df3testNewPrecip %>% group_by(Year) %>% count() %>% filter(n!=12)
# checking whether there is NAs --> none
df3testNewPrecip %>% filter(is.na(Precip_mm))

df3testNewPrecip <- df3testNewPrecip %>% 
  unite("year_month",Year:Month,sep="_") %>% 
  pivot_wider(names_from = year_month,
              values_from = Precip_mm) %>% 
  slice(rep(row_number(), max(df2testNew$plot_new))) %>%  #162 equals the number of plots for exp==1
  mutate(ID = 1:n()) %>% 
  column_to_rownames(var="ID") %>% 
  as.matrix()

# wrangling data for MAX TEMPERATURE variable
df3testNewMaxTemp <- df3testNew %>% 
  select(Year,Month,MaxTemp_C) %>% 
  mutate(ID=1) 

# checking whether the data is complete
df3testNewMaxTemp %>% group_by(Year) %>% count() %>% filter(n!=12)
# checking whether there is NAs --> none
df3testNewMaxTemp %>% filter(is.na(MaxTemp_C))

df3testNewMaxTemp <- df3testNewMaxTemp %>% 
  unite("year_month",Year:Month,sep="_") %>% 
  pivot_wider(names_from = year_month,
              values_from = MaxTemp_C) %>% 
  slice(rep(row_number(), max(df2testNew$plot_new))) %>%  #162 equals the number of plots
  mutate(ID = 1:n()) %>% 
  column_to_rownames(var="ID") %>% 
  as.matrix()

# creating means for weather data

df3testNew_Mean <- df3testNew %>% 
  group_by(Month) %>% 
  summarise(MaxTemp_C=mean(MaxTemp_C),
         Precip_mm=mean(Precip_mm)) %>% 
  mutate(ID=1) %>% 
  ungroup()

# wrangling data for PRECIPTATION MEAN variable
df3testNew_MeanPrecip <- df3testNew_Mean %>% 
  select(-MaxTemp_C) %>% 
  pivot_wider(names_from = Month,
              values_from = Precip_mm) %>% 
  slice(rep(row_number(), max(df2testNew$plot_new))) %>%  #162 equals the number of plots
  mutate(ID = 1:n()) %>% 
  column_to_rownames(var="ID") %>% 
  as.matrix()

# wrangling data for MAX TEMPERATURE MEAN variable
df3testNew_MeanMaxTemp <- df3testNew_Mean %>% 
  select(-Precip_mm) %>% 
  pivot_wider(names_from = Month,
              values_from = MaxTemp_C) %>% 
  slice(rep(row_number(), max(df2testNew$plot_new))) %>%  #162 equals the number of plots
  mutate(ID = 1:n()) %>% 
  column_to_rownames(var="ID") %>% 
  as.matrix()

## what Drew needs given the changes in the model
# clim.means will be 12 months x 3 variables.
clim.means <- df3testNew_Mean %>% 
  select(Precip_mm, MaxTemp_C) %>% 
  as.matrix()
# clim.matrix will be monthly climate x 3 variables.
clim.matrix <- df3testNew %>% 
  select(Precip_mm, MaxTemp_C) %>% 
  as.matrix()
```

- Creating blocks for months
```{r}
# the time block that each month is assigned to such that for 60 different
# months, we are only estimating 38 unique monthly weights
block <- c(1,1,1,2,2,2,3,3,3,4,4,4,
           5,5,5,6,6,6,7,7,7,8,8,8,
           9,9,9,10,10,10,11,11,11,12,12,12)

block <- matrix(block[1:36], nrow = 3, byrow = TRUE) #3 rows, 12 columns, 3 x 12 = 36

bsize <- c(3,3,3)
```

exporting data
```{r}
save.image(paste0(file.path(dataout,paste(c("DataModel_", expName, ".RData"), collapse=""))))
```

# No disturbance

Wrangling data to match Drew's code
Given a type of disturbance, create plot and year indices
```{r}

expName <- "NoDist_CoarseEnv" #exp==1, this object will be used later on to save files accordingly

df2testNew <- df2test %>% 
  filter(exp==1) %>% #1 = no disturbance
  arrange(field,ntrt,year,plot, exp) %>% #new plot ID by field
  group_by(ntrt,field,exp,plot) %>%
  mutate(plot_new = cur_group_id()) %>% 
  ungroup() %>% 
  arrange(year) %>% 
  group_by(year) %>% 
  mutate(year_new = cur_group_id()) %>% 
  ungroup() %>% 
  arrange(plot_new)

#adding AR column
ARyearID <- df2testNew %>% 
  select(field,year_new,plot_sum,exp,ntrt,plot) %>% 
  mutate(year_new=year_new+1) %>% 
  rename(ARplot_sum=plot_sum)

df2testNew <- df2testNew %>% 
  left_join(ARyearID,by = join_by(field,plot, exp, ntrt, year_new)) %>% 
  mutate(ARplot_sum=ifelse(is.na(ARplot_sum),NA,ARplot_sum)) #adding zero cover as the first because in this particular case, disturbance happened and the field was tilled. my assumption is that no vegetation survived.

#checking for missing years in the chronosequence
df2testNew %>% 
  select(plot_new, year_new) %>% 
  distinct() %>% 
  group_by(plot_new) %>% 
  count() %>% 
  ungroup() %>% 
  filter(n!=23) #nope! every plot has all the 23 years of data! awesome!

#maximum length of plots with data
df2testNew %>% 
  select(plot_new, year_new) %>% 
  distinct() %>% 
  group_by(plot_new) %>% 
  count() %>% 
  ungroup() %>% 
  arrange(desc(n)) %>% 
  select(n) %>% 
  group_by(n) %>%
  count() %>% 
  ungroup()

maxLength <- df2testNew %>% 
  select(plot_new, year_new) %>% 
  distinct() %>% 
  group_by(plot_new) %>% 
  count() %>% 
  ungroup() %>% 
  arrange(desc(n)) %>% 
  select(n) %>% 
  group_by(n) %>%
  count() %>% 
  ungroup() %>% 
  filter(n==max(n)) %>%  as.numeric()


# Maximum number of plots
max(df2testNew$plot_new)

#disturbance index
df2testNewNtrt <- df2testNew %>% 
  select(plot_new,ntrt) %>% 
  distinct()
glimpse(df2testNewNtrt)

#range of years with plant data
range(df2testNew$year) #1982 to 2004, 1982-5 = 1977, so weather data should be from 1977 to 2004
yearRange<-range(df2testNew$year)
```

- Weather data
```{r}
#filtering the years of interest
df3testNew <- df3test %>% 
  filter(Year > yearRange[1]-3,
         Year < yearRange[2]+1)
range(df3testNew$Year) #correct!

#number of plots
max(df2testNew$plot_new)

# wrangling data for PRECIPTATION variable
df3testNewPrecip <- df3testNew %>% 
  select(Year,Month,Precip_mm) %>% 
  mutate(ID=1) 

# checking whether the data is complete
df3testNewPrecip %>% group_by(Year) %>% count() %>% filter(n!=12)
# checking whether there is NAs --> none
df3testNewPrecip %>% filter(is.na(Precip_mm))

df3testNewPrecip <- df3testNewPrecip %>% 
  unite("year_month",Year:Month,sep="_") %>% 
  pivot_wider(names_from = year_month,
              values_from = Precip_mm) %>% 
  slice(rep(row_number(), max(df2testNew$plot_new))) %>%  #162 equals the number of plots for exp==1
  mutate(ID = 1:n()) %>% 
  column_to_rownames(var="ID") %>% 
  as.matrix()

# wrangling data for MAX TEMPERATURE variable
df3testNewMaxTemp <- df3testNew %>% 
  select(Year,Month,MaxTemp_C) %>% 
  mutate(ID=1) 

# checking whether the data is complete
df3testNewMaxTemp %>% group_by(Year) %>% count() %>% filter(n!=12)
# checking whether there is NAs --> none
df3testNewMaxTemp %>% filter(is.na(MaxTemp_C))

df3testNewMaxTemp <- df3testNewMaxTemp %>% 
  unite("year_month",Year:Month,sep="_") %>% 
  pivot_wider(names_from = year_month,
              values_from = MaxTemp_C) %>% 
  slice(rep(row_number(), max(df2testNew$plot_new))) %>%  #162 equals the number of plots
  mutate(ID = 1:n()) %>% 
  column_to_rownames(var="ID") %>% 
  as.matrix()

# creating means for weather data
df3testNew_Mean <- df3testNew %>% 
  group_by(Month) %>% 
  summarise(MaxTemp_C=mean(MaxTemp_C),
         Precip_mm=mean(Precip_mm)) %>% 
  mutate(ID=1) %>% 
  ungroup()

# wrangling data for PRECIPTATION MEAN variable
df3testNew_MeanPrecip <- df3testNew_Mean %>% 
  select(-MaxTemp_C) %>% 
  pivot_wider(names_from = Month,
              values_from = Precip_mm) %>% 
  slice(rep(row_number(), max(df2testNew$plot_new))) %>%  #162 equals the number of plots
  mutate(ID = 1:n()) %>% 
  column_to_rownames(var="ID") %>% 
  as.matrix()

# wrangling data for MAX TEMPERATURE MEAN variable
df3testNew_MeanMaxTemp <- df3testNew_Mean %>% 
  select(-Precip_mm,) %>% 
  pivot_wider(names_from = Month,
              values_from = MaxTemp_C) %>% 
  slice(rep(row_number(), max(df2testNew$plot_new))) %>%  #162 equals the number of plots
  mutate(ID = 1:n()) %>% 
  column_to_rownames(var="ID") %>% 
  as.matrix()

## what Drew needs given the changes in the model
# clim.means will be 12 months x 3 variables.
clim.means <- df3testNew_Mean %>% 
  select(Precip_mm, MaxTemp_C) %>% 
  as.matrix()
# clim.matrix will be monthly climate x 3 variables.
clim.matrix <- df3testNew %>% 
  select(Precip_mm, MaxTemp_C) %>% 
  as.matrix()
```

- Creating blocks for months
```{r}
# the time block that each month is assigned to such that for 60 different
# months, we are only estimating 38 unique monthly weights
block <- c(1,1,1,2,2,2,3,3,3,4,4,4,
           5,5,5,6,6,6,7,7,7,8,8,8,
           9,9,9,10,10,10,11,11,11,12,12,12)

block <- matrix(block[1:36], nrow = 3, byrow = TRUE) #3 rows, 12 columns, 3 x 12 = 36

bsize <- c(3,3,3)
```

exporting data
```{r}
save.image(paste0(file.path(dataout,paste(c("DataModel_", expName, ".RData"), collapse=""))))
```
