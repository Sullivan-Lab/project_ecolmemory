---
title: "L2_dataAnalysis_CDCRdata_Nutrient_Dist"
author: "laís petri"
date: "2024-05-29"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
rm(list = ls())
started <- Sys.time()
```

Loading R packages
```{r, echo=FALSE}
## data wrangling + plots
library(tidyverse) 
library(scales)
## correlation plots
library(ggcorrplot)
## models
library(rjags)
library(coda)
## color blind discrete colors
library(pals) 
```

Paths to import files, and export outputs
```{r}
workingdir <- getwd()
datain <- file.path(workingdir, "data/L1")
graph.wd <- file.path(workingdir, "figures")
parameters.wd <- file.path(workingdir, "parameters/CoarseEnv_FieldsAB")
```

Importing dataset
```{r}
load(file.path(datain,"DataModel_NoDist_Litter_FieldsAB_CoarseEnv.RData"))
# expName <- "Dist_CoarseEnv"
```

General objects (model)
```{r}
n_burnin = 300000
n_iter = 150000
n_thin = 50
```

## Model
Organizing variables
```{r}
datamodel <- list(N = nrow(df2testNew), # sample size
                  biomass = df2testNew$plot_sum, # dependent variable
                  plot = df2testNew$plot_new, # plot sequenced IDs
                  year = df2testNew$year_new, # year sequenced IDs
                  AR = df2testNew$ARplot_sum, # auto regressive term
                  D = length(unique(df2testNew$ntrt)), # maximum number of nutrient treatments (9 levels)
                  V = 2, # variables, 1=ppt, 2=temp, 3=pdsi
                  B = 12, # these are the 12 “free-weights”
                  L = 3, # lag (in years) up to l=5, l=1 is current growing season
                  M = 12, # month
                  block = block, # matrix (rows are years, cols are months), define the blocks to calculate the weights
                  bsize = bsize, # aggregation level in with the months will be grouped
                  Y = maxLength[1], # maximum length of years across all plots = 10 or 23
                  P = max(df2testNew$plot_new), # maximum number of plots
                  nutrient = df2testNewNtrt$ntrt, # plot level nutrient treatment (9 levels)
                  # ppt = df3testNewPrecip, # precipitation data. Rows are plot_new and cols are max length of years across all plots (23) + 5 (pre-beginning of data collection) 
                  # temp = df3testNewMaxTemp, # maximum temperature data. Rows are plot_new and cols are max length of years across all plots (23) + 5 (pre-beginning of data collection) 
                  # pdsi = df3testNewPDSI, # pdsi. Rows are plot_new and cols are max length of years across all plots (23) + 5 (pre-beginning of data collection)
                  clim.matrix = clim.matrix, # 12 months x 3 variables.
                  clim.means = clim.means 
                  # Pmean = df3testNew_MeanPrecip, # mean precipitation across all years
                  # Tmean = df3testNew_MeanMaxTemp, # mean maximum temperature across all years
                  # Dmean = df3testNew_MeanPDSI #mean pdsi across all years
                  # richness = df2testNew$richness # plot level richness
                  )
```

Initials
```{r}
num.coef <- 4 # number of coefficients ('a' in the model)
initials <- 
  list(
  list(a = matrix(0.1, nrow = num.coef, ncol = max(df2testNew$plot_new)),
       tau = c(rep(1, times = 1)),
       mu_a = c(rep(0.5, times = num.coef-1)),
       deltaX = array(rep(0.1, 9 * 12 * 2), dim = c(9, 12, 2)),
       sig_a = c(rep(0.5, times = num.coef-1))),
       # sig_a_ntrt = matrix(0.1, nrow = num.coef, ncol = length(unique(df2testNew$ntrt)))),
  list(a = matrix(1, nrow = num.coef, ncol = max(df2testNew$plot_new)),
       tau = c(rep(0.5, times = 1)),
       mu_a = c(rep(0.1, times = num.coef-1)),
       deltaX = array(rep(0.5, 9 * 12 * 2), dim = c(9, 12, 2)),
       sig_a = c(rep(0.1, times = num.coef-1))),
       # sig_a_ntrt = matrix(1, nrow = num.coef, ncol = length(unique(df2testNew$ntrt)))),
  list(a = matrix(0.5, nrow = num.coef, ncol = max(df2testNew$plot_new)),
       tau = c(rep(0.1, times = 1)),
       mu_a = c(rep(1, times = num.coef-1)),
       deltaX = array(rep(1, 9 * 12 * 2), dim = c(9, 12, 2)),
       sig_a = c(rep(1, times = num.coef-1)))
       # sig_a_ntrt = matrix(0.5, nrow = num.coef, ncol = length(unique(df2testNew$ntrt))))
  )
```

Model
```{r}
## This a modification of the tree ring dendrochronologies model from Peltier et al. 2018
#
# Reference:
#
# Peltier, D. M. P., Barber, J. J., & Ogle, K. (2018). Quantifying antecedent 
# climatic drivers of tree growth in the Southwestern US. Journal of Ecology, 106(2), 613-624. https://doi.org/https://doi.org/10.1111/1365-2745.12878 

Model1 <- "
model{

#ANTECEDENT VARIABLES
  # Calculate *pseudo-mean* antecedent variables
  for(v in 1:V){ # variable 1 = precipitation, 2 = temperature, 3 = PDSI
    for(d in 1:D){ # nutrient, 1-9
      for(l in 1:L){  # lag (in years) up to l=5, l=1 is current growing season
        for(m in 1:M){ # month 1-12
          antm1[m,l,v,d] <- delta[d,m,l,v]* # deltas are non-identifiable weights
            (clim.means[m,v])
        }
        antm2[l,v,d]<-sum(antm1[1:12,l,v,d])
      }
      antM[v,d]<-sum(antm2[1:L,v,d])
    }
  } # close variable (V) loop
  
  # Compute antecedent climate variables for climate variable V and time into the
  # past l (l = 1 is the current year):
  for(d in 1:D){ # nutrient, 1-9
    for(v in 1:V){ # variable, 1-3
      for(j in 1:B){ # block, 1-38, these are the 35 *free weights*  
        # block weights
        weightX[d,j,v] <- deltaX[d,j,v]/sum(deltaX[d,,v]) # calculate identifiable block weights
      }
    }
    
    # Calculate sums
    for(v in 1:V){ # variable, 1-3
      for(l in 1:L){ # number of lag years, 1-5
        Nsum1[d,l,v]<-sum(delta[d,1:12,l,v]) # across months
        Wsum1[d,l,v]<-sum(weight[d,1:12,l,v])
      }
      Nsum[d,v] <- sum(Nsum1[d,1:L,v]) # sum deltas across lags
      Wsum[d,v] <- sum(Wsum1[d,1:L,v])
    }
    
    for(m in 1:M){ # month, 1-12
      for(v in 1:V){ # variable, 1-3
        for(l in 1:L){ # number of lag years, 1-5
          # extract monthly x lag x climvar delta from blockwise deltaX
          # this creates the vectors of 60 deltas that we use in the model, from the 35 *free* weights (for each variable v) 
          delta[d,m,l,v] <- (deltaX[d,block[l,m],v]/bsize[l])*(1-equals(l,1)*step(m-9.5)) #set current year post growing season weights (Sept, Oct, Nov, Dec) a priori to zero
          weight[d,m,l,v] <- delta[d,m,l,v]/Nsum[d,v] # compute identifiable weights 
          weightOrdered[d,(l-1)*12 + (12-m+1),v] <- weight[d,m,l,v] # reorder weights
        } 
      } 
    }
    
    for(l in 1:L){ # number of lag years, 1-5
      for(v in 1:V){ # variable, 1-3
        # Compute identifiable year weights:
        yr.w[d,l,v] <- sum(weight[d,1:12,l,v]) # construct annual weights
      }
    }
  } # close nutrient (D) loop
  
  # Construct the antecedent variable and uses computational *trick* to speed convergence time from Ogle et al. (2015)
  for(m in 1:M){ # month, 1-12
    for(v in 1:V){ # variable, 1-3
      for(l in 1:L){ # number of lag years, 1-5
        for(y in 1:Y){ # maximum number of years, 10, 23
          for(d in 1:D){ # nutrient, 1-9
            # antX1[m,y,l,v,p] <-  equals(v,1)* delta[nutrient[p],m,l,v]*ppt[p,24+12*(y-1) + m -(l-1)*12]
            # + equals(v,2)* delta[nutrient[p],m,l,v]*temp[p,24+12*(y-1) + m -(l-1)*12]
            # + equals(v,3)* delta[nutrient[p],m,l,v]*pdsi[p,24+12*(y-1) + m -(l-1)*12]
            antX1[m,y,l,v,d] <-  delta[d,m,l,v]*clim.matrix[24+12*(y-1) + m -(l-1)*12,v]
          }  
        }
      } 
    }
  } # close month (M) loop
  
  for(y in 1:Y){ # maximum number of years, 10, 23
    for(v in 1:V){ # variable, 1-3
      for(l in 1:L){ # number of lag years, 1-5
        for(d in 1:D){ # nutrient, 1-9
          # Compute the antecedent variable by summing the weighted variables
          # First sum over past months:  
          ant_sum1[y,l,v,d] <- sum(antX1[,y,l,v,d])
        }
      }
      #either ppt or temp
      # Now sum over past years, this will be used in mean model (below)
      for(d in 1:D){ # plot, 162
        antX[y,v,d] <- sum(ant_sum1[y,,v,d])
      }
    }
  }
  
# LIKELIHOOD
  for(i in 1:N){ # sample size, 3726
    biomass[i] ~ dnorm(mu_biomass[i], tau)  
    repY[i] ~ dnorm(mu_biomass[i], tau) # replicated data for computing R2
    
    residuals[i]<-repY[i]-biomass[i] # calculates residuals

# MEAN MODEL 
    # Linear regression with (centered) antecedent climatic covariates, richness and auto-regressive terms
    mu_biomass[i] <- a[1,plot[i]] # plot level intercept
                   + a[2,plot[i]]*(antX[year[i],1,nutrient[plot[i]]]- antM[1,nutrient[plot[i]]]) # antecedent covariate: preciptation
                   + a[3,plot[i]]*(antX[year[i],2,nutrient[plot[i]]]-antM[2,nutrient[plot[i]]]) # antecedent covariate: max temperature
                   # + a[4,plot[i]]*(antX[year[i],3,nutrient[plot[i]]]-antM[3,nutrient[plot[i]]]) # antecedent covariate: max temperature
                   + a[4,plot[i]]*AR[i] # auto-regressive term

    # data likelihood for missing data
    AR[i] ~ dnorm(0,0.0001)I(0,)
    # richness[i] ~ dnorm(0,0.0001)I(0,)
  }
 
  # Compute identifiable parameters only for those parameters multiplied by non-identifiable antX (these are monitored)
  for(p in 1:P){ # plot, 162
    a_star[1,p]<-a[1,p]
    a_star[2,p]<-a[2,p]*Nsum[nutrient[p],1]
    a_star[3,p]<-a[3,p]*Nsum[nutrient[p],2]
    a_star[4,p]<-a[4,p]
  }
  
  # Compute identifiable nutrient level parameters only for those parameters multiplied by non-identifiable antX (these are monitored):
  for(d in 1:D){ # nutrient, 1-9
    mu_a_ntrt.star[1,d]<-mu_a_ntrt[1,d]
    mu_a_ntrt.star[2,d]<-mu_a_ntrt[2,d]*Nsum[d,1]
    mu_a_ntrt.star[3,d]<-mu_a_ntrt[3,d]*Nsum[d,2]
    mu_a_ntrt.star[4,d]<-mu_a_ntrt[4,d]
  }
  
# Compute identifiable global effects
mu_a.star[2] <- mu_a[2] * mean(Nsum[,1])
mu_a.star[3] <- mu_a[3] * mean(Nsum[,2])
  
# PRIOR DISTRIBUTIONS
  # Block delta priors
  for(d in 1:D){ # nutrient, 1-9
    for(v in 1:V){ # variable, 1-2
      for(j in 1:B){ # block, 38
        deltaX[d,j,v] ~ dgamma(1, 1)
      } 
    }
  }
  
  # relatively non-informative priors to sd parameters:    
  for(p in 1:3){ # 4 out of 5 coefficients
    tau_a[p] <- pow((1/sig_a[p]), 2)
    sig_a[p] ~ dunif(0, 100)
    mu_a[p] ~ dnorm(0, 0.0001) # global mean priors
  }
   
  for(p in 1:3){ # 4 out of 5 coeficients
    for(d in 1:D){ # nutrient, 1-9
      mu_a_ntrt[p,d] ~ dnorm(mu_a[p],tau_a[p])  # hierarchical nutrient level priors
      tau_a_ntrt[p,d] ~ dgamma(0.001, 0.001)     # Precision prior (Gamma)
      sig_a_ntrt[p,d] <- 1 / sqrt(tau_a_ntrt[p,d]) # Standard deviation derived from precision
    }
  } 
  
  for(d in 1:D){ # nutrient, 1-9
    #prior for auto-regressive term
    mu_a_ntrt[4,d] ~ dunif(0,100)
    tau_a_ntrt[4,d] ~ dgamma(0.001, 0.001)     # Precision prior (Gamma)
    sig_a_ntrt[4,d] <- 1 / sqrt(tau_a_ntrt[4,d]) # Standard deviation derived from precision
  }
  
  for(s in 1:4){ # all 5 coefficients
    for(p in 1:P){ # plot, 162
      a[s,p] ~ dnorm(mu_a_ntrt[s,nutrient[p]], tau_a_ntrt[s,nutrient[p]]) # hierarchical nutrient-level prior
    }
  }
  
  # observation precision (from likelihood)
  tau ~ dunif(0, 100)
  sig <- pow((1/tau), 0.5) 
  
} # end of model"
```

Compile
```{r}
set.seed(500)
load.module("dic")
m <-jags.model(textConnection(Model1), 
               data=datamodel,
               n.chains=3, 
               inits = initials)
```

Burn-in period of 100000 iterations
```{r}
set.seed(500)
update(m, n_burnin)
```

Model DIC value
```{r}
set.seed(500)
dic_Dist <- dic.samples(m, n.iter=1000, thin = 1, type = "pD")
```

Running model and retrieving parameters
Plot: Posterior distributions
```{r}
set.seed(500)
parameters<-coda.samples(m, variable.names = c("a_star", #plot-level intercepts and effects of variables
                                               "repY", # replicated data for R2
                                               "tau", # likelihood variance
                                               "mu_a.star", "tau_a", # global effects of variables
                                               "residuals", # model residuals
                                               "weightOrdered", # weights for each month
                                               "yr.w", # yearly weights
                                               "Dsum", # env scaling effect
                                               "mu_a_ntrt.star", "tau_a_ntrt", # nutrient-level parameter estimates
                                               "deviance"), 
                         n.iter = n_iter, # samples to be kept after burn in
                         thin = n_thin, # thinning rate, save every 50th iteration to reduce correlation between consecutive values in the chain, #50
) 
parameters0_Dist<-summary(parameters)

#exports parameters to calculate % of posterior distribution above thresholds
write_csv(as.data.frame(as.matrix(parameters)) %>%
            select(starts_with("mu_a"), 
                   starts_with("weightOrdered"), 
                   starts_with("yr.w")), 
          paste0(file.path(parameters.wd,paste(c(expName, "_parameters.csv"), collapse=""))))

# Extract the parameter names
param_names <- varnames(parameters)

# Exclude repY and residuals
filtered_params <- param_names[!grepl("^repY\\[|^residuals\\[", param_names)]

# Plot only the selected parameters
pdf(paste0(file.path(parameters.wd, paste(c(expName, "_PosteriorDistributions.pdf"), collapse=""))))
par(mar = c(2, 2, 2, 2)) 
plot(parameters[, filtered_params])  # Subset parameters before plotting
dev.off()
```

Exporting parameter values, predictions and residuals
```{r}
Quantiles <- as.data.frame(parameters0_Dist[2]) %>% 
  mutate_if(is.numeric, round,digits=4) %>% 
  rownames_to_column(., var = "parameter") %>% select(1,2,6)

Stats <- as.data.frame(parameters0_Dist[1]) %>% 
  mutate_if(is.numeric, round,digits=4) %>% 
  rownames_to_column(., var = "parameter") %>% 
  select(1:3) %>% left_join(Quantiles)
write_csv(Stats, paste0(file.path(parameters.wd,paste(c(expName, "_ParametersValues.csv"), collapse=""))))
```

Plot: predicted vs. observed to calculate R2
```{r fit}
Metric <- df2testNew$plot_sum
Mean_pred <- Stats %>% filter(grepl("^repY",parameter)) %>% select(statistics.Mean)
Mean_pred <- Mean_pred$statistics.Mean

predModel <- cbind(Mean_pred, Metric) %>% as.data.frame()

fit <- lm(Metric ~ Mean_pred, data=predModel)

ggplot(data = predModel, aes(y = Metric, x = Mean_pred)) +
  stat_function(fun = function(x) predict(fit, newdata = data.frame(Mean_pred = x)),
                color = "black", linewidth = 2) +
  annotate(label = sprintf("y = %.3f + %.3f x\nR² = %.2f", coef(fit)[1], coef(fit)[2], summary(fit)$r.squared),
           geom = "text", x = 2000, y = 6000, size = 5) +
  geom_point(shape=19,size=5,alpha=0.5) +
  # xlim(0,1300)+
  ylab("Observed values")+
  xlab("Predicted values")+ 
  theme_classic()+
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text.y = element_text(size = 25),
        axis.text.x = element_text(size = 25),
        axis.title = element_text(size = 25),
        axis.line = element_line(colour = "black"))

ggsave(paste0(file.path(graph.wd,paste(c(expName, "_ModelFit_BIOMASS_.png"), collapse=""))), plot = last_plot(), width=7, height=5, dpi = 300, units="in")
```

Plot: residuals vs predicted to evaluate model
```{r}
Metric_pred <- Stats %>% filter(grepl("^repY",parameter)) %>% select(statistics.Mean)
Metric_pred <- Metric_pred$statistics.Mean
Residuals <- Stats %>% filter(grepl("^residuals",parameter)) %>% select(statistics.Mean)
Residuals <- Residuals$statistics.Mean

predModel <- cbind(Metric_pred, Residuals) %>% as.data.frame()

ggplot(data = predModel, aes(y = Residuals, x = Metric_pred)) +
  geom_hline(yintercept=0)+
  geom_point(shape=19,size=5,alpha=0.5) +
  ylab("Residuals")+
  xlab("Predicted values")+ 
  theme_classic()+
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text.y = element_text(size = 25),
        axis.text.x = element_text(size = 25),
        axis.title = element_text(size = 25),
        axis.line = element_line(colour = "black"))

ggsave(paste0(file.path(graph.wd,paste(c(expName, "_ModelResiduals_.png"), collapse=""))), plot = last_plot(), width=7, height=5, dpi = 300, units="in")
```

## Outputs
```{r}
# how long did this model take to run?
ended <- Sys.time()
started - ended
```

```{r}
# saving model output
save.image(paste0(file.path(parameters.wd,paste(c(expName, "_CDCR_ModelOutput.RData"), collapse=""))))
```